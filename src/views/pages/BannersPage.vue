<template>
  <div class="app-management-page">
    <BaseHeader
      :pageIcon="'mdi-image-area'"
      :title="t('banners')"
      :desc="t('manageYourAppsBanners')"
      :show-button="true"
      :button-text="t('newBanner')"
      v-on:button-pressed="() => (isEmployeeDrawerOpen = true)"
    />
    <div class="page-content">
      <div class="cards">
        <InfoCard class="infoCard" :cardTitle="t('totalBanners')">
          {{ stats.totalAds }}
        </InfoCard>
        <InfoCard class="infoCard" :cardTitle="t('activeBanners')">
          {{ stats.activeAds }}
        </InfoCard>
        <InfoCard class="infoCard" :cardTitle="t('deactiveBanners')">
          {{ stats.deactiveAds }}
        </InfoCard>
      </div>
      <hr class="infoHr" />
      <ServerTable
        :headers="headers"
        :items="ads"
        :total-items="pagination.total"
        :loading="loading"
        v-model:page="page"
        v-model:items-per-page="itemsPerPage"
      >
        <template #cell-_id="{ item }"> #{{ item._id.substring(0, 6) }} </template>
        <template #cell-image="{ item }">
          <img
            :src="item.image"
            style="max-width: 80px; width: 80px; max-height: 40px; object-fit: cover"
          />
        </template>
        <!-- <template #cell-url="{ item }">
          <span>{{ item.url }}</span>
        </template> -->
        <template #cell-status="{ item }">
          <v-chip
            :color="getColorAccordingToExpireDate(item?.expireDate)"
            text-color="white"
            small
          >
            <span
              :style="{ backgroundColor: statusColorAccordingToExpireDate(item.expireDate) }"
              class="status-circle"
            ></span>
            {{ getStatusAccordingToExpireDate(item.expireDate) }}
          </v-chip>
        </template>
        <template #cell-expireDate="{ item }">
          <span>
            {{ formatDateWithoutTime(item.createdAt) }} -
            {{ formatDateWithoutTime(item.expireDate) }}</span
          >
        </template>
        <template #actions="{ item }">
          <v-menu location="bottom end" offset="4">
            <template #activator="{ props }">
              <v-btn icon v-bind="props" variant="text" density="comfortable">
                <v-icon>mdi-dots-vertical</v-icon>
              </v-btn>
            </template>
            <v-list class="menu-list pa-0 ma-0">
              <v-list-item class="menu-item" @click="viewDetails(item)">
                <v-icon class="mr-2">mdi-eye-outline</v-icon>
                {{ t('seeDetails') }}
              </v-list-item>
              <v-list-item class="menu-item" @click="deleteAd(item)">
                <v-icon class="mr-2">mdi-trash-can-outline</v-icon>
                {{ t('deleteBanner') }}
              </v-list-item>
            </v-list>
          </v-menu>
        </template>
      </ServerTable>
      <!-- add Drawer -->
      <Drawer
        :isOpen="isEmployeeDrawerOpen"
        :desc="t('newBanner')"
        :status="t('busy')"
        @close="isEmployeeDrawerOpen = false"
      >
        <div style="max-height: 75vh">
          <form @submit.prevent="onAddButtonPressed()" class="form">
            <div>
              <div class="drawer-banner">
                <p>{{ t('information') }}</p>
              </div>
              <div>
                <div class="drawer-info">
                  <p class="drawer-key">URL</p>
                  <p class="drawer-value">https://example.com</p>
                </div>
                <div class="drawer-info">
                  <p class="drawer-key">Expire Date</p>
                  <p class="drawer-value">2024-12-31</p>
                </div>
              </div>
              <div class="action-btns">
                <ActionButton
                  :buttonText="t('cancel')"
                  buttonColor="white"
                  @button-pressed="() => (isEmployeeDrawerOpen = false)"
                />
                <ActionButton :buttonText="t('addBanner')" buttonType="submit" />
              </div>
            </div>
          </form>
        </div>
      </Drawer>
      <!-- add Drawer -->
      <!-- delete Drawer -->
      <Drawer
        :isOpen="isDeleteEmployeeDrawerOpen"
        :desc="t('deleteBanner')"
        :status="t('busy')"
        @close="isDeleteEmployeeDrawerOpen = false"
      >
        <div style="max-height: 75vh">
          <form @submit.prevent="onDeleteButtonPressed(selectedAd!._id)" class="form">
            <div>
              <div class="drawer-banner">
                <p>{{ t('information') }}</p>
              </div>
              <div>
                <div class="drawer-info">
                  <p class="drawer-key">URL</p>
                  <p class="drawer-value">{{ selectedAd?.url }}</p>
                </div>
                <div class="drawer-info">
                  <p class="drawer-key">Expire Date</p>
                  <p class="drawer-value">
                    {{ selectedAd ? formatDateWithoutTime(selectedAd.expireDate) : 'N/A' }}
                  </p>
                </div>
                <div class="drawer-info">
                  <p class="drawer-key">ID</p>
                  <p class="drawer-value">{{ selectedAd?._id?.substring(0, 6) }}</p>
                </div>
              </div>
              <div class="action-btns">
                <ActionButton
                  :buttonText="t('cancel')"
                  buttonColor="white"
                  @button-pressed="() => (isDeleteEmployeeDrawerOpen = false)"
                />
                <ActionButton
                  button-color="error"
                  :buttonText="t('deleteBanner')"
                  buttonType="submit"
                />
              </div>
            </div>
          </form>
        </div>
      </Drawer>
      <!-- delete Drawer -->
      <!-- update Drawer -->
      <Drawer
        :isOpen="isUpdateEmployeeDrawerOpen"
        :desc="t('newEmployee')"
        :status="t('busy')"
        @close="isUpdateEmployeeDrawerOpen = false"
      >
        <div style="max-height: 75vh">
          <form @submit.prevent="onUpdateButtonPressed()" class="form">
            <div>
              <div class="drawer-banner">
                <p>{{ t('information') }}</p>
              </div>
              <div>
                <div class="drawer-info">
                  <p class="drawer-key">{{ t('fullName') }}</p>
                  <p class="drawer-value">Zaid Al-Farsi</p>
                </div>
                <div class="drawer-info">
                  <p class="drawer-key">{{ t('employeeID') }}</p>
                  <p class="drawer-value">784-678-9012-3</p>
                </div>
                <div class="drawer-info">
                  <p class="drawer-key">{{ t('phoneNumber') }}</p>
                  <p class="drawer-value">+971 (51) 123-4567</p>
                </div>
              </div>
              <div class="action-btns">
                <ActionButton
                  :buttonText="t('cancel')"
                  buttonColor="white"
                  @button-pressed="() => (isUpdateEmployeeDrawerOpen = false)"
                  class="action-Btn"
                />
                <ActionButton
                  class="action-Btn"
                  :buttonText="t('updateEmployee')"
                  buttonType="submit"
                />
              </div>
            </div>
          </form>
        </div>
      </Drawer>
      <!-- update Drawer -->

      <ConfirmPopupDialog
        :isVisible="isConfirmDeletePopupVisible"
        :title="t('deleteConfirmBanner')"
        :message="t('deleteConfirmBannerDescription')"
        :icon="'mdi-trash-can-outline'"
        :iconColor="'error'"
        @cancel="closeDeletePopup"
        @apply="onDeleteButtonPressed(selectedAd!._id)"
        :cancelText="t('cancel')"
        :applyText="t('deleteConfirmButton')"
      />
    </div>
  </div>
</template>
<script setup lang="ts">
import ActionButton from '@/components/base/ActionButton.vue'
import BaseHeader from '@/components/base/BaseHeader.vue'
import Drawer from '@/components/base/Drawer.vue'
import InfoCard from '@/components/base/InfoCard.vue'
import ServerTable from '@/components/base/ServerTable.vue'
import ConfirmPopupDialog from '@/components/base/ConfirmPopupDialog.vue'
import { ref, onMounted, computed, watch } from 'vue'
import { useI18n } from 'vue3-i18n'
import { useAdsStore } from '@/stores/modules/adsStore'
import { IAd } from '@/models/ad'
import { toastDeleteMessage, toastSuccessMessage } from '@/utils/helpers/notification'
import { formatDateWithoutTime } from '@/utils/helpers/date-helper'

const { t } = useI18n()
const isEmployeeDrawerOpen = ref(false)
const isDeleteEmployeeDrawerOpen = ref(false)
const isUpdateEmployeeDrawerOpen = ref(false)
const isConfirmDeletePopupVisible = ref(false)

const adsStore = useAdsStore()
const loading = computed(() => adsStore.isLoading)
const ads = computed(() => adsStore.allAds)

const pagination = computed(
  () => adsStore.paginationInfo || { total: 0, page: 1, limit: 8, pageCount: 1 },
)
const stats = computed(() => adsStore.adsStats || { totalAds: 0, activeAds: 0, deactiveAds: 0 })
const page = ref(1)
const selectedAd = ref<IAd | null>(null)
const itemsPerPage = ref(8)

const headers = [
  { title: 'ID', key: '_id', sortable: false },
  { title: t('bannerImage'), key: 'image', sortable: false },
  { title: t('bannerTitle'), key: 'url', sortable: false },
  { title: t('startEndDate'), key: 'expireDate', sortable: false },
  { title: t('status'), key: 'status', sortable: false },
  { title: t('actions'), key: '', sortable: false },
]

const getColorAccordingToExpireDate = (expireDate: string | Date) => {
  switch (getStatusAccordingToExpireDate(expireDate)) {
    case t('active'):
      return 'green'
    case t('deactive'):
      return 'red'
    default:
      return 'grey'
  }
}

const closeDeletePopup = () => (isConfirmDeletePopupVisible.value = false)

const fetchAds = async () => {
  const response = await adsStore.getAds({ page: page.value, limit: itemsPerPage.value })
  if (response.pagination && response.pagination.page !== page.value) {
    page.value = response.pagination.page
  }
  const totalPages = Math.ceil((response.pagination?.total ?? 0) / itemsPerPage.value)
  if (page.value > totalPages && totalPages > 0) {
    page.value = totalPages
  }
}

const fetchStats = async () => {
  await adsStore.getAdsStats()
}

onMounted(() => {
  fetchAds()
  fetchStats()
})

watch([page, itemsPerPage], fetchAds)

const onDeleteButtonPressed = async (selectedAdId: string) => {
  toastDeleteMessage(t('toastDeleteBannerTitle'), t('toastDeleteBannerDescription'))
  if (!selectedAdId) {
    console.error('No ad selected for deletion')
    return
  }
  // await adsStore.deleteAd(selectedAdId)
  isDeleteEmployeeDrawerOpen.value = false
}
const onAddButtonPressed = () => {
  isEmployeeDrawerOpen.value = false
  toastSuccessMessage(t('toastAddBannerTitle'), t('toastAddBannerDescription'))
}
const onUpdateButtonPressed = () => {
  isUpdateEmployeeDrawerOpen.value = false
}

const statusColorAccordingToExpireDate = (date: string | Date): 'green' | 'red' | 'grey' => {
  const now = new Date()
  const expire = new Date(date)

  if (expire > now) return 'green'
  if (expire.toDateString() === now.toDateString()) return 'grey'
  return 'red'
}



function getStatusAccordingToExpireDate(expireDate: string | Date) {
  const currentDate = new Date()
  const expiredDate = new Date(expireDate)
  if (expiredDate < currentDate) {
    return t('deactive')
  }
  return t('active')
}

function viewDetails(item: any) {
  selectedAd.value = item as IAd
  isUpdateEmployeeDrawerOpen.value = true
}

function deleteAd(item: any) {
  selectedAd.value = item as IAd
  isDeleteEmployeeDrawerOpen.value = true
}
</script>
<style lang="scss">
.menu-list {
  min-width: 140px;
  background-color: white;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.menu-item {
  font-size: 14px;
  padding: 6px 12px;
  min-height: unset !important;
}
</style>
